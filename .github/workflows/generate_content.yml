name: Generate & Stock

on:
  # schedule:
  #  - cron: "0 4 * * *"   # 13:00 JST
  workflow_dispatch:
    inputs:
      count:
        description: "How many entries to generate"
        default: "3"

concurrency:
  group: gen-stock
  cancel-in-progress: false

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      COUNT: ${{ github.event.inputs.count || '5' }}
      DURATION: "10"
      BG: assets/bg        # ディレクトリ指定 → ランダム
      AUDIO: assets/bgm    # ディレクトリ指定 → ランダム
      LANGS_TO_RENDER: "en,ja,es"   # ← es に変更

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true   # ← これ超重要。LFS実体を取る

      - name: Git LFS pull (safety)
        run: |
          git lfs version || sudo apt-get update && sudo apt-get install -y git-lfs
          git lfs install
          git lfs pull

      - name: Set DATE (today)
        run: echo "DATE=$(date +%F)" >> $GITHUB_ENV

      - uses: actions/setup-node@v4
        with: { node-version: "20" }

      - name: Install deps (ffmpeg + fonts)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg \
            fonts-noto fonts-noto-cjk fonts-noto-color-emoji \
            fonts-dejavu-core
          npm ci || npm install --no-audit --no-fund

      - name: Verify OPENAI key
        env:
          K: ${{ secrets.OPENAI_API_KEY }}
        run: |
          [ -n "${K:-}" ] || { echo "OPENAI_API_KEY missing"; exit 1; }
          echo "OPENAI_API_KEY OK"

      # ① seedsプール → EN YAML（ランダム、未使用優先）
      - name: Seeds(pool) -> EN YAML
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: node scripts/seed_to_yaml.js --count=${{ env.COUNT }}

      # ② EN → world 翻訳（その日の EN を明示）
      - name: EN -> world translate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: node scripts/translate_yaml.js --date=${DATE} --langs=ja,es  # ← es に変更

      # ③レンダリング（今日の日付で出力）
      - name: Render videos (world)
        run: |
          IFS=',' read -ra LGS <<< "${{ env.LANGS_TO_RENDER }}"
          for L in "${LGS[@]}"; do
            if [ -f "data/$L/${DATE}.yaml" ]; then
              node scripts/render_video.js --lang=$L --date=${DATE} --dur=${{ env.DURATION }} --bg=${{ env.BG }} --audio=${{ env.AUDIO }}
            else
              echo "skip $L (data/$L/${DATE}.yaml not found)"
            fi
          done

      # デバッグ: 実際に使うフォントとBG/BGMを一行で可視化（任意）
      - name: Debug fonts/files
        run: |
          ls -la assets/fonts || true
          fc-list | head || true

      # 在庫コミット（使用済みシードの状態も残す）
      - name: Commit stock
        run: |
          git config user.name  "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add videos/*/queue/${DATE} data/_state/used_seeds.json || true
          git commit -m "stock: ${DATE} videos (random from pool)" || echo "nothing to commit"
          git push || true
